services:
    - type: web
      name: resume-scorer-api
      env: python
      region: oregon
      plan: starter
      buildCommand: "./render-build.sh"
      startCommand: "cd api && gunicorn --bind=0.0.0.0:$PORT --workers=2 --threads=2 app:app --timeout 120"
      envVars:
          - key: PYTHON_VERSION
            value: 3.10.8
          - key: PORT
            value: 8080
          - key: ENVIRONMENT
            value: production
          - key: RENDER
            value: true
          - key: TRANSFORMERS_OFFLINE
            value: 1
          - key: HF_DATASETS_OFFLINE
            value: 1
          - key: PYTHONUNBUFFERED
            value: true
          # Optimize Python memory usage
          - key: PYTHONMALLOC
            value: malloc
          - key: MALLOC_TRIM_THRESHOLD_
            value: 65536
          # Disable JIT compilation to save memory
          - key: PYTORCH_JIT
            value: 0
          # Keep memory footprint small
          - key: OMP_NUM_THREADS
            value: 1
          - key: MKL_NUM_THREADS
            value: 1
          # Optimize garbage collection
          - key: PYTHONGC
            value: threshold-aggressive
          # Increase memory reclamation
          - key: TORCH_EXTENSIONS_CACHE
            value: /tmp/torch_extensions
          # Enable model optimizations
          - key: USE_QUANTIZED_MODEL
            value: 1
          - key: USE_TASK_SPECIFIC_MODELS
            value: 1
          - key: OPTIMIZE_MEMORY
            value: 1
          - key: MEMORY_CONSTRAINED
            value: 1
          - key: CUDA_VISIBLE_DEVICES
            value: ""
          - key: MODEL_WARMUP_ON_START
            value: true
      plan: free
      disk:
          name: resume-scorer-data
          mountPath: /opt/render/project/src/model_cache
          sizeGB: 2
      healthCheckPath: /health
      autoDeploy: false # Disable auto-deployment to save resources
      # Add sensible auto-scaling parameters for free tier
      scaling:
          minInstances: 1
          maxInstances: 2
          targetMemoryPercent: 85
          targetCPUPercent: 80
      resources:
        limits:
          memory: 1Gi
          cpu: 0.5
        requests:
          memory: 512Mi
          cpu: 0.25

# A Redis instance for job queuing
databases:
  - name: resume-queue
    plan: free
    type: redis
